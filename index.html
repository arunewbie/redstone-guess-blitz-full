<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RedStone Fans Game</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/logo-redstone.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

  <style>
    :root{--primary:#ff1e00;--bg:#0b0b0f;--muted:#9aa0a6;--card:#13141a}
    *{box-sizing:border-box}
    body{
      background:url('/images/redstone-bg.png') no-repeat center center fixed;
      background-size:cover;
    }
    body::before{
      content:'';position:fixed;inset:0;
      backdrop-filter:blur(8px);
      background:rgba(0,0,0,0.45);
      z-index:0;
    }

    /* Title */
    #titleText{color:#fff!important;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;letter-spacing:.3px;text-shadow:0 0 10px rgba(255,255,255,.25);}
    .title-logo{height:40px;width:auto}
    .title-text{color:#fff!important}
    @media(max-width:520px){.title-logo{height:32px}}

    header{padding:22px 18px 6px;text-align:center;position:relative;z-index:1;}
    h1{margin:0;font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:14px}
    .container{max-width:1080px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:18px;position:relative;z-index:1;}
    @media(max-width:960px){.container{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1e2027;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .game{padding:16px}
    .board{display:flex;justify-content:center;align-items:center;padding:8px;}
    canvas{width:100%;max-width:560px;height:auto;display:block;border-radius:14px;border:1px solid #242633;background:#0b0c12}

    /* Timer */
    #labelTime{font-size:20px;font-weight:800;}
    #totalLeft{font-size:32px;font-weight:800;text-shadow:0 0 10px rgba(255,30,0,.6);transition:all .3s}
    #labelTime.warn #totalLeft{color:#ff9800;text-shadow:0 0 10px rgba(255,152,0,.6)}
    #labelTime.urgent #totalLeft{color:#ff1e00;text-shadow:0 0 12px rgba(255,30,0,.8);animation:pulse 1s infinite;}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
    #timeBar{height:6px;background:#ff1e00;transition:width 1s linear;}

    .status{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;margin:12px 0;flex-direction:column;}
    .badge{background:#191b22;border:1px solid #252830;padding:6px 10px;border-radius:999px;font-size:13px;color:#d5d7dc}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
    button{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#1d212b;color:#e7e9ee;border:1px solid #2a2f3a}
    button.ghost{background:transparent;border:1px dashed #3a3f4d;color:#c9cbd2}
    button:disabled{opacity:.45;cursor:not-allowed;filter:saturate(.6)}
    #shareX{margin-top:6px;}

    .sidebar{padding:16px;display:grid;gap:12px}
    .panel{background:#0f1117;border:1px solid #1f232d;border-radius:14px;padding:14px}
    .panel h3{margin:0 0 8px;font-size:15px;color:#e8eaee}
    .row{display:flex;gap:8px}
    input[type=text]{flex:1;background:#0c0e13;border:1px solid #232634;color:#e9ebf1;border-radius:12px;padding:10px 12px}
    .hint{font-size:13px;color:#aab1ba;margin-top:6px}
    .list{display:grid;gap:6px;font-size:14px;color:#cdd1d7;max-height:150px;overflow:auto}
    .ok{color:#66ef9a}
    .wrong{color:#ff7a7a}
    .muted{color:#9aa0a6}
    .footer{padding:18px;text-align:center;color:#9aa0a6;position:relative;z-index:1;}
    .leaderboard-entry{display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:4px 0}
    .leaderboard-entry span{font-size:14px}
    .danger{color:#ff7a7a}

    /* Flash & Shake */
    .flash-overlay{
      position:fixed;inset:0;background:rgba(255,59,48,0.28);
      animation:flashOut .6s ease-out forwards;
      pointer-events:none;z-index:3;
    }
    @keyframes flashOut{from{opacity:1}to{opacity:0}}
    .board.shake{animation:shake .6s ease}
    @keyframes shake{
      0%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-6px)}
      80%{transform:translateX(6px)}
      100%{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <header>
    <h1 id="titleText">
      <img src="/images/logo-redstone.svg" alt="RedStone logo" class="title-logo" />
      <span class="title-text">RedStone Fans Game</span>
    </h1>
    <div class="sub">Guess the Team RedStone member as quickly as possible within 60 seconds. Highest scores go on the public leaderboard. üèÜ</div>
  </header>

  <main class="container">
    <section class="card game">
      <div class="board">
        <canvas id="board" width="560" height="560"></canvas>
      </div>
      <div class="status">
        <div class="badge" id="labelQuestion">Question <span id="qIndex">1</span>/<span id="qTotal">1</span></div>
        <div class="badge" id="labelScore">Score: <span id="score">0</span></div>
        <div class="badge" id="labelGrid">Grid: <span id="gridLabel">3√ó3</span></div>
        <div class="badge" id="labelSeed">Seed: <span id="seedLabel">‚Äî</span></div>
        <div class="badge" id="labelTime">Blitz Time: <span id="totalLeft">60</span>s</div>
        <div id="timeTrack" style="width:100%;background:#222;border-radius:8px;overflow:hidden;">
          <div id="timeBar" style="width:100%"></div>
        </div>
      </div>
      <div class="controls">
        <button id="reshuffle" class="secondary">‚§Æ Reshuffle</button>
        <button id="startBlitz" disabled>‚ö° Start Blitz</button>
        <button id="stopBlitz" class="ghost">‚ñ† Stop Blitz</button>
      </div>
    </section>

    <aside class="card sidebar">
      <div class="panel">
        <h3>Username</h3>
        <div class="row"><input id="username" type="text" placeholder="Your username..." /></div>
      </div>

      <div class="panel">
        <h3>Your Answer</h3>
        <div class="row">
          <input id="answer" type="text" placeholder="e.g. ALEX / JAKUB / MATT" />
          <button id="submit">Submit</button>
        </div>
        <div id="feedback" class="hint muted">Type your answer then press <b>Submit</b>.</div>
      </div>

      <div class="panel">
        <h3>History</h3>
        <div id="history" class="list"></div>
      </div>

      <div class="panel">
        <h3>Leaderboard üèÜ</h3>
        <div id="leaderboard" class="list"></div>
        <button id="shareX" class="secondary">Share on X (Twitter)</button>
      </div>
    </aside>
  </main>

  <div class="footer">Made by arunewbie for Redstone Community</div>

  <script>
    // === Questions ===
    const QUESTIONS = [
      { image:'alex1.png',answers:['ALEX','alex'] },
      { image:'alex2.png',answers:['ALEX','alex'] },
      { image:'jakub1.png',answers:['JAKUB','jakub'] },
      { image:'matt1.png',answers:['MATT','matt'] },
      { image:'morgana.png',answers:['MORGANA','morgana'] },
    ];
    const IMAGE_BASE = '/images/';

    // === Utils ===
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function seededShuffle(arr,rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
    function normalize(s){return s.replace(/\s+/g,'').toUpperCase();}

    // === DOM ===
    const canvas=document.getElementById('board'),ctx=canvas.getContext('2d');
    const qIndexEl=document.getElementById('qIndex'),qTotalEl=document.getElementById('qTotal');
    const scoreEl=document.getElementById('score'),seedLabel=document.getElementById('seedLabel');
    const totalLeftEl=document.getElementById('totalLeft'),answerEl=document.getElementById('answer');
    const feedbackEl=document.getElementById('feedback'),historyEl=document.getElementById('history');
    const leaderboardEl=document.getElementById('leaderboard');
    const startBtn=document.getElementById('startBlitz'),stopBtn=document.getElementById('stopBlitz');
    const submitBtn=document.getElementById('submit'),usernameInput=document.getElementById('username');
    const shareBtn=document.getElementById('shareX'), timeBar=document.getElementById('timeBar');

    const state={idx:0,score:0,rows:3,cols:3,seed:Date.now()>>>0,revealCount:0,totalTime:60,totalLeft:60,totalTimer:null,ended:true,lastBeepAt:null};
    qTotalEl.textContent=QUESTIONS.length;

    // === Audio beep ===
    let audioCtx=null;
    function ensureAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
    function beep({freq=900,duration=140,type='sine',volume=0.12}={}){
      const ctx=ensureAudio();const o=ctx.createOscillator();const g=ctx.createGain();
      o.type=type;o.frequency.setValueAtTime(freq,ctx.currentTime);
      g.gain.setValueAtTime(volume,ctx.currentTime);
      o.connect(g).connect(ctx.destination);o.start();
      g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+duration/1000);
      o.stop(ctx.currentTime+duration/1000+0.01);
    }

    // === Leaderboard ===
    async function saveScore(username,score){
      try{if(!username)username='Anon';
        const res=await fetch('/api/leaderboard',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:username,score})});
        if(!res.ok)throw new Error();
      }catch{
        let board=JSON.parse(localStorage.getItem('leaderboard')||'[]');
        board.push({name:username,score:score,date:Date.now()});
        board.sort((a,b)=>b.score-a.score);
        board=board.slice(0,10);
        localStorage.setItem('leaderboard',JSON.stringify(board));
      }
      renderLeaderboard();
    }
    async function fetchLeaderboard(){
      try{const r=await fetch('/api/leaderboard');if(!r.ok)throw new Error();return await r.json();}
      catch{return JSON.parse(localStorage.getItem('leaderboard')||'[]');}
    }
    async function renderLeaderboard(){
      leaderboardEl.innerHTML='';
      const data=await fetchLeaderboard();
      (data||[]).forEach((e,i)=>{
        const d=document.createElement('div');
        d.className='leaderboard-entry';
        d.innerHTML=`<span>${i+1}. ${e.name}</span><span>${e.score}</span>`;
        leaderboardEl.appendChild(d);
      });
    }

    // === Game draw ===
    function loadImage(src){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=rej;img.src=IMAGE_BASE+src;});}
    async function drawScramble(img,rows,cols,seed){
      const w=canvas.width,h=canvas.height;ctx.clearRect(0,0,w,h);
      const ratio=Math.max(w/img.width,h/img.height);
      const dw=img.width*ratio,dh=img.height*ratio;
      const dx=(w-dw)/2,dy=(h-dh)/2;
      const tiles=[];for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)tiles.push({r,c});
      const rng=mulberry32(seed);const order=seededShuffle(tiles.slice(),rng);
      const sw=dw/cols,sh=dh/rows,tw=w/cols,th=h/rows;
      for(let i=0;i<order.length;i++){
        const src=order[i];const tr=Math.floor(i/cols),tc=i%cols;
        const sx=dx+src.c*sw,sy=dy+src.r*sh,tx=tc*tw,ty=tr*th;
        ctx.drawImage(img,sx,sy,sw,sh,tx,ty,tw,th);
        ctx.strokeStyle='rgba(255,255,255,.06)';ctx.strokeRect(tx+0.5,ty+0.5,tw-1,th-1);
      }
    }
    async function drawCurrent(){
      const q=QUESTIONS[state.idx];qIndexEl.textContent=state.idx+1;seedLabel.textContent=state.seed;
      const img=await loadImage(q.image);await drawScramble(img,state.rows,state.cols,state.seed);
    }

    // === History ===
    function addHistory(t,cls=''){const d=document.createElement('div');d.textContent=t;if(cls)d.classList.add(cls);historyEl.prepend(d);}

    // === Timer ===
    function updateTotalUI(){
      totalLeftEl.textContent=Math.max(0,state.totalLeft);
      const badge=document.getElementById('labelTime');
      badge.classList.remove('warn','urgent');
      if(state.totalLeft<=10)badge.classList.add('urgent');
      else if(state.totalLeft<=20)badge.classList.add('warn');
      timeBar.style.width=((state.totalLeft/state.totalTime)*100)+'%';
      if(!state.ended && state.totalLeft<=10 && state.totalLeft>=1){
        if(state.lastBeepAt!==state.totalLeft){
          state.lastBeepAt=state.totalLeft;
          beep({freq:700+(10-state.totalLeft)*60,duration:120,type:'triangle',volume:0.14});
        }
      }
    }

    // === Controls ===
    function updateStartState(){startBtn.disabled=usernameInput.value.trim().length===0;}
    usernameInput.addEventListener('input',updateStartState);

    function startBlitz(){
      if(!usernameInput.value.trim()){feedbackEl.innerHTML='‚ö†Ô∏è Please enter a username.';return;}
      state.ended=false;state.score=0;scoreEl.textContent=0;historyEl.innerHTML='';
      state.lastBeepAt=null;stopBlitz();state.totalLeft=state.totalTime;updateTotalUI();
      state.totalTimer=setInterval(()=>{
        state.totalLeft--;updateTotalUI();
        if(state.totalLeft<=0){endBlitz();}
      },1000);
      seededShuffle(QUESTIONS,mulberry32(Date.now())); // acak urutan pertanyaan
      state.idx=0;drawCurrent();
    }

    function stopBlitz(){if(state.totalTimer){clearInterval
